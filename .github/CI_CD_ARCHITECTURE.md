# CI/CD 架构文档

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         GitHub Repository                        │
│                  sheldon123z/Rural-Low-Voltage-Detection        │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                  ┌─────────────┴─────────────┐
                  │    Git Push / PR Event    │
                  └─────────────┬─────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   Code Push   │      │  Pull Request │      │   Schedule    │
│  (main/dev)   │      │   (opened)    │      │  (Weekly Mon) │
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        ▼                      ▼                      ▼
┌───────────────────────────────────────────────────────────────┐
│                     GitHub Actions Workflows                   │
├───────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │     CI       │  │ Code Quality │  │   Testing    │        │
│  │   (main)     │  │   (style)    │  │ (3.9-3.11)   │        │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
│         │                 │                 │                  │
│         └─────────────────┼─────────────────┘                  │
│                          │                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │   Security   │  │Documentation │  │PR Validation │        │
│  │  (weekly)    │  │   (docs)     │  │    (info)    │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
└───────────────────────────┬───────────────────────────────────┘
                            │
                ┌───────────┴───────────┐
                │                       │
                ▼                       ▼
        ┌──────────────┐        ┌──────────────┐
        │   Success    │        │   Failure    │
        │   ✅ Pass    │        │   ❌ Fail    │
        │              │        │              │
        │ • Badge 更新 │        │ • 通知开发者 │
        │ • 日志保存   │        │ • 显示错误   │
        │ • PR 可合并  │        │ • 阻止合并   │
        └──────────────┘        └──────────────┘
```

## 工作流层次结构

### 第一层：入口触发器
```
触发事件类型：
├── Push Events (代码推送)
│   ├── main 分支
│   ├── develop 分支
│   └── copilot/** 分支
├── Pull Request Events
│   ├── opened (PR 创建)
│   ├── synchronize (PR 更新)
│   └── reopened (PR 重新打开)
└── Schedule Events
    └── cron: "0 0 * * 1" (每周一)
```

### 第二层：工作流选择
```
路径过滤器：
├── **.py → code-quality.yml, testing.yml, ci.yml
├── requirements.txt → testing.yml, security.yml
├── **.md → documentation.yml
└── thesis/** → documentation.yml
```

### 第三层：检查执行
```
CI Pipeline:
├── [1] 环境准备
│   ├── Checkout 代码
│   ├── 设置 Python 3.11
│   └── 安装依赖 (pip cache)
├── [2] 代码质量
│   ├── Black 格式化检查
│   ├── isort 导入排序
│   └── flake8 代码检查
├── [3] 测试执行
│   ├── 模型导入测试
│   ├── 模型实例化测试
│   └── 单元测试 (pytest)
└── [4] 结果报告
    ├── GitHub Summary
    ├── 状态徽章更新
    └── 日志归档
```

## 数据流图

```
┌──────────────┐
│ 开发者本地   │
│ 代码开发     │
└──────┬───────┘
       │
       │ git push
       ▼
┌──────────────┐
│  GitHub 仓库 │
│  代码接收    │
└──────┬───────┘
       │
       │ webhook
       ▼
┌──────────────┐     并行执行     ┌──────────────┐
│ Workflow 1   │ ───────────────▶ │ Runner 1     │
│ (ci.yml)     │                  │ Ubuntu Latest│
└──────────────┘                  └──────┬───────┘
                                         │
┌──────────────┐                         │ 结果
│ Workflow 2   │ ───────────────▶ ┌──────▼───────┐
│ (testing.yml)│                  │ GitHub API   │
└──────────────┘                  │ 状态更新     │
                                  └──────┬───────┘
┌──────────────┐                         │
│ Workflow 3   │ ───────────────▶        │
│(security.yml)│                         │
└──────────────┘                         ▼
                                  ┌──────────────┐
                                  │  PR/Commit   │
                                  │  状态显示    │
                                  └──────────────┘
```

## 检查矩阵

### 代码质量维度

| 工具     | 检查内容          | 严格度 | 修复方式     |
|----------|-------------------|--------|--------------|
| Black    | 代码格式化        | 警告   | 自动修复     |
| isort    | 导入语句排序      | 警告   | 自动修复     |
| flake8   | 语法错误          | 严格   | 手动修复     |
| flake8   | 代码质量          | 警告   | 手动修复     |

### 测试覆盖矩阵

| Python 版本 | 模型测试 | 单元测试 | 数据生成 |
|-------------|----------|----------|----------|
| 3.9         | ✅       | ✅       | ✅       |
| 3.10        | ✅       | ✅       | ✅       |
| 3.11        | ✅       | ✅       | ✅       |

### 安全扫描维度

| 工具       | 扫描类型     | 频率     | 结果处理 |
|------------|--------------|----------|----------|
| safety     | 已知漏洞     | 每周     | 警告     |
| pip-audit  | 依赖审计     | 每周     | 警告     |

## 工作流依赖关系

```
开发者提交代码
       │
       ▼
┌─────────────┐
│ CI (主流程) │
│  必须通过   │
└──────┬──────┘
       │
       ├─────────────────┐
       │                 │
       ▼                 ▼
┌──────────────┐  ┌──────────────┐
│ Code Quality │  │   Testing    │
│  建议通过    │  │   必须通过   │
└──────────────┘  └──────────────┘
       │                 │
       └────────┬────────┘
                │
                ▼
        ┌──────────────┐
        │  PR Review   │
        │  可以合并    │
        └──────────────┘
```

## 性能优化策略

### 1. 缓存策略
```yaml
- uses: actions/setup-python@v5
  with:
    cache: 'pip'  # 缓存 pip 包
```

### 2. 并行执行
```yaml
strategy:
  matrix:
    python-version: ['3.9', '3.10', '3.11']
    # 3个版本并行测试
```

### 3. 条件触发
```yaml
on:
  push:
    paths:
      - '**.py'  # 仅 Python 文件变更时触发
```

### 4. 早期失败
```yaml
continue-on-error: false  # 关键检查失败立即停止
```

## 监控和告警

### 状态徽章位置
- README.md 顶部
- 实时显示各工作流状态
- 点击可查看详细日志

### 失败通知
- GitHub 通知
- Email 提醒
- PR 状态检查阻止合并

### 日志保留
- GitHub Actions 保留 90 天
- 可导出用于分析
- 支持重新运行

## 扩展性设计

### 添加新工作流
1. 在 `.github/workflows/` 创建新的 YAML 文件
2. 定义触发条件和 jobs
3. 在 README.md 添加状态徽章

### 添加新检查步骤
1. 在现有工作流的 `steps` 中添加
2. 配置 `continue-on-error` 属性
3. 更新文档

### 添加新工具
1. 在 `pyproject.toml` 添加依赖
2. 在工作流中安装和配置
3. 在文档中说明用法

## 成本分析

### 免费额度（GitHub Actions）
- 公共仓库：无限制
- 私有仓库：2,000 分钟/月（免费账户）

### 预估使用
- 单次 CI 运行：~5 分钟
- 完整测试矩阵：~15 分钟
- 每天 10 次提交：~150 分钟/天

### 优化建议
- 使用缓存减少安装时间
- 路径过滤避免不必要的运行
- 并行执行提高效率

## 安全考虑

### 密钥管理
- 使用 GitHub Secrets 存储敏感信息
- 不在日志中输出密钥
- 定期轮换密钥

### 权限控制
- 最小权限原则
- 读写分离
- 审计日志

### 依赖安全
- 定期扫描漏洞
- 及时更新依赖
- 使用 Dependabot

## 合规性

### 代码规范
- PEP 8 (Python)
- Black 格式化标准
- 88 字符行长度

### 测试标准
- 模型必须可导入
- 关键功能必须有测试
- 测试覆盖率报告

### 文档要求
- Markdown 格式规范
- 链接必须有效
- 代码示例可运行

---

**维护**: 本文档随 CI/CD 系统更新而更新
**版本**: 1.0.0
**日期**: 2026-01-24
