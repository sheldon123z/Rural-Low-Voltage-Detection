name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get PR details
      run: |
        echo "## Pull Request Information ðŸ“‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Base Branch:** ${{ github.event.pull_request.base.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Head Branch:** ${{ github.event.pull_request.head.ref }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Check commit messages
      run: |
        echo "## Commit Message Validation ðŸ“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Get commits in this PR
        git log --format="%s" origin/${{ github.event.pull_request.base.ref }}..HEAD | while read msg; do
          echo "- $msg" >> $GITHUB_STEP_SUMMARY
        done
        
    - name: Check file changes
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Files Changed ðŸ“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count files by type
        total=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | wc -l)
        py_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | grep -c "\.py$" || echo 0)
        md_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | grep -c "\.md$" || echo 0)
        
        echo "- **Total files changed:** $total" >> $GITHUB_STEP_SUMMARY
        echo "- **Python files:** $py_files" >> $GITHUB_STEP_SUMMARY
        echo "- **Markdown files:** $md_files" >> $GITHUB_STEP_SUMMARY
        
  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check PR size
      run: |
        # Calculate lines changed
        additions=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}..HEAD | awk '{sum+=$1} END {print sum}')
        deletions=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}..HEAD | awk '{sum+=$2} END {print sum}')
        
        echo "## PR Size Analysis ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Lines added:** $additions" >> $GITHUB_STEP_SUMMARY
        echo "- **Lines deleted:** $deletions" >> $GITHUB_STEP_SUMMARY
        echo "- **Net change:** $((additions - deletions))" >> $GITHUB_STEP_SUMMARY
        
        # Warn if PR is too large
        if [ "$additions" -gt 500 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Warning:** This PR is quite large. Consider breaking it into smaller PRs for easier review." >> $GITHUB_STEP_SUMMARY
        fi
