name: Testing

on:
  push:
    branches: [ main, develop, copilot/** ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/testing.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r code/voltage_anomaly_detection/requirements.txt
        pip install pytest pytest-cov pytest-xdist
        
    - name: Test model imports and instantiation
      working-directory: code/voltage_anomaly_detection
      run: |
        # Set environment to avoid potential issues
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        
        # Run the model test script
        python test_models.py
      continue-on-error: false
      
    - name: Run unit tests with pytest (if tests directory exists)
      working-directory: code/voltage_anomaly_detection
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v --tb=short --cov=. --cov-report=term-missing
        else
          echo "No tests directory found, skipping pytest"
        fi
      continue-on-error: true
      
    - name: Test data generation script
      working-directory: code/voltage_anomaly_detection/dataset/RuralVoltage
      run: |
        if [ -f "generate_sample_data.py" ]; then
          python generate_sample_data.py --train_samples 100 --test_samples 20 --anomaly_ratio 0.1
          echo "✓ Sample data generation test passed"
        fi
      continue-on-error: true
      
    - name: Summary
      if: always()
      run: |
        echo "### Testing Complete for Python ${{ matrix.python-version }} ✓" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Model import and instantiation tests completed" >> $GITHUB_STEP_SUMMARY
        echo "- Unit tests executed (if present)" >> $GITHUB_STEP_SUMMARY
        echo "- Data generation validated" >> $GITHUB_STEP_SUMMARY
